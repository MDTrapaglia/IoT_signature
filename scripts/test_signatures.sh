#!/bin/bash

BASE_URL="http://localhost:3001"
ACCESS_TOKEN="c90e31d3f88c8851687014fa69a601fb65717449a3d07a50bd84ee75046fb885"
PUB_KEY="D27CBD596D2272C63502D6A186C09D9D8101DD3448CB367E3B28DDF1A9D66E4140D3C4D11DF201EB1E6E512054414B49B82B13024A1202D0DAC8FB4253E988E8"

format() {
  if command -v jq &>/dev/null; then
    jq .
  else
    cat
  fi
}

SIGNATURES=(
  "6FA9ADECE1E8BF3CDD34440964F2CF5AEF460480F7A96C75A7367A4B4D1D360ABE20856DE311EB357337B896A0C137295FB8F5223F65AEEC33275DC9E3AED9D2"
  "A4B333E09816BFD4AF040C1245BC61DF335A109A23EDF760D22641DCC06554A17BD74CC5DA223CEA1693931E7624462268DB0466B11D9461FD4BA3B98703BC61"
  # Firma inválida (último dígito modificado: DE -> DF)
  "F1D8BDEF68171A6990231E40DD583F19D667E6C2E585E44FE42E7237F36AE0CEF2237AF9CD87889934A4C28D9397DA54946E88C40B2E3E8F3B54FAD4273111DF"
  "F1D8BDEF68171A6990231E40DD583F19D667E6C2E585E44FE42E7237F36AE0CEF2237AF9CD87889934A4C28D9397DA54946E88C40B2E3E8F3B54FAD4273111DE"
  "E3FFF6392F74522740B23853417731F91D026CE1A8556514CED85E90ADB2B13EEFAE85BAEDE00EA8185DE10B717584FF50A02548F4320700DC0D4699906DC033"
)

HASH="ABDD6FCAE1168AAB0278BC7E5D0B86671F720AEC6BB00CBF070C6136BC0ACAC7"

echo "=== Testing ECDSA Signature Validation ==="
echo ""

for i in "${!SIGNATURES[@]}"; do
  echo "--- Payload $((i+1)) ---"
  curl -s -X POST "$BASE_URL/api/ingest?token=$ACCESS_TOKEN" \
    -H "Content-Type: application/json" \
    -d "{
      \"sensor_id\": \"ESP32_001\",
      \"hash\": \"$HASH\",
      \"signature\": \"${SIGNATURES[$i]}\",
      \"publicKey\": \"$PUB_KEY\"
    }" | format
  echo ""
done

echo "=== All Measurements ==="
curl -s "$BASE_URL/api/measurements?token=$ACCESS_TOKEN" | format
